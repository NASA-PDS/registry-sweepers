# ðŸ›ž Continuous Integration and Delivery: Unstable
# =================================================
#
# Note: for this workflow to succeed, the following secrets must be installed
# in the repository (or inherited from the repository's organization):
#
# ``ADMIN_GITHUB_TOKEN``
#     A personal access token of a user with collaborator or better access to
#     the project repository. You can generate this by visiting GitHub â†’
#     Settings â†’ Developer settings â†’ Personal access tokens â†’ Generate new
#     token. Give the token scopes on ``repo``, ``write:packages``,
#     ``delete:packages``, ``workflow``, and ``read:gpg_key``.
#


---

name:  Publish Image to DockerHub


# Driving Event
# -------------
#
# What event starts this workflow: manual trigger only

on: workflow_dispatch


# What to Do
# ----------
#
# Round up, yee-haw!

jobs:
    unstable-assembly:
        name: ðŸ›ž Unstable Assembly
        if: github.actor != 'pdsen-ci'
        runs-on: ubuntu-latest
        steps:
            -
                name: ðŸ’³ Checkout
                uses: actions/checkout@v3
                with:
                    lfs: true
                    token: ${{secrets.ADMIN_GITHUB_TOKEN}}
                    fetch-depth: 0
            -
                name: ðŸ’µ Python Cache
                uses: actions/cache@v3
                with:
                    path: ~/.cache/pip
                    # The "key" used to indicate a set of cached files is the operating system runner
                    # plus "py" for Python-specific builds, plus a hash of the wheels, plus "pds" because
                    # we pds-prefix everything with "pds" in PDS! ðŸ˜…
                    key: pds-${{runner.os}}-py-${{hashFiles('**/*.whl')}}
                    # To restore a set of files, we only need to match a prefix of the saved key.
                    restore-keys: pds-${{runner.os}}-py-
            -
                name: ðŸ’³ Docker Hub Identification
                uses: docker/login-action@v2
                with:
                    username: ${{secrets.DOCKERHUB_USERNAME}}
                    password: ${{secrets.DOCKERHUB_TOKEN}}
            -
                name: ðŸŽ° QEMU Multiple Machine Emulation
                uses: docker/setup-qemu-action@v2
            -
                name: ðŸš¢ Docker Buildx
                uses: docker/setup-buildx-action@v2
            -
              name: ðŸ§± Image Construction and Publication
              uses: docker/build-push-action@v3
              with:
                  context: ./
                  file: ./docker/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{secrets.DOCKERHUB_USERNAME}}/registry-sweepers:latest

...

# -*- mode: yaml; indent: 4; fill-column: 120; coding: utf-8 -*-
